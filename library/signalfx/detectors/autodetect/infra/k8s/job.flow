from signalfx.detectors.autodetect import utils
from signalfx.detectors.autodetect.infra.k8s import utils as k8s_utils

def job_fail_pct_high(fire_threshold: float = 90, fire_lasting: lasting = lasting('5m', 0.8), filter_: filter = None):
    # Detects when job fail pods % count is > 90
    # :param fire_lasting description=Specifies trigger sensitivity associated with trigger threshold
    # :param fire_lasting label=Trigger sensitivity
    # :param clear_lasting description=Specifies clear sensitivity associated with clear threshold
    # :param clear_lasting label=Clear sensitivity
    # :param filter_ description=Specifies dimensional scope of the detector
    # :param filter_ metric_name=k8s.job.failed_pods
    # :return: detect block that triggers when containers suitably filtered and grouped, cannot start
    group_by = [k8s_utils.K8S_CLUSTER_NAME_DIM,
                k8s_utils.K8S_NAMESPACE_NAME_DIM,
                "k8s.job.name"]

    failed_pods_stream = data('k8s.job.failed_pods', filter=filter_, rollup='latest').sum(by=group_by, allow_missing=group_by)
    successful_pods_stream = data('k8s.job.successful_pods', filter=filter_, rollup='latest').sum(by=group_by, allow_missing=group_by)
    stream = (failed_pods_stream / (failed_pods_stream + successful_pods_stream)) * 100

    fire_threshold_stream = const(fire_threshold)

    ann = [utils.annotate_stream(stream, 'Job failed pods'),
           utils.annotate_fire_threshold(fire_threshold_stream, orientation='above')]
    return detect(when(stream > fire_threshold_stream, lasting=fire_lasting),
                annotations=ann,
                auto_resolve_after=utils.AUTO_RESOLVE_AFTER)
