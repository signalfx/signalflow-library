def blended(guard: float = 300, headroom: float = 1.5, filter_ = None):
    # Detect when latency degrades, compared to historical latencies
    # :param guard label=Heuristic floor (millis)
    # :param guard description=Don't alert for latencies under this.
    # :param headroom label=Headroom multiplier (unitless; 1.0-2.0)
    # :param headroom description=How much worse latency must be, compared to historical, in order to trigger an alert.
    # :param filter_ label=Additional filter
    # :param filter_ description=Optionally refine the set of observed entities with an additional filter.
    # :return: detect block that triggers when latency degrades
    guard_nanos = guard * 1e6
    if filter_ is None:
        _filter = filter('sf_error', 'false')
    else:
        _filter = filter_ and filter('sf_error', 'false')
    by_ = ['sf_service', 'sf_environment']
    p90 = histogram('service.request', filter=_filter).percentile(pct=90, by=by_).fill(duration='10m').publish('P90 Latency')
    p90_today = p90.percentile(pct=80, over='12h')
    p90_yesterday = p90.percentile(pct=80, over='2h').timeshift('23h')
    p90_weekago = p90_yesterday.timeshift('6d')
    alert_level = max(max(p90_today, p90_yesterday, p90_weekago) * headroom, guard_nanos)
    return detect(
        on= when(p90 > threshold(alert_level), lasting='15m', at_least=0.8),
        off=when(p90 <= threshold(alert_level), lasting='20m', at_least=0.85),
        auto_resolve_after='1d',
    )
